---
language: shell
dist: xenial
sudo: required
os: linux

services:
  - docker
  
    jobs:
  include:
    - stage: Manifest creation
      install: skip
      script: skip
      after_deploy:
        - docker login -u "$DOCKER_USER" -p "$DOCKER_PASS";
        - docker manifest create ${NAME}:${VERSION} ${NAME}:${VERSION}-amd64 ${NAME}:${VERSION}-s390x ${NAME}:${VERSION}-ppc64le;
        - docker manifest annotate ${NAME}:${VERSION} ${NAME}:${VERSION}-amd64 --os linux --arch amd64;
        - docker manifest annotate ${NAME}:${VERSION} ${NAME}:${VERSION}-s390x --os linux --arch s390x;
        - docker manifest annotate ${NAME}:${VERSION} ${NAME}:${VERSION}-ppc64le --os linux --arch ppc64le;

addons:
  apt:
    packages:
      - docker-ce

env:
  - DEPLOY=false repo=lucashalbert/curl docker_archs="amd64 ppc64le s390x"
  
install:
  - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

before_script:
  - export ver=$(curl -s "https://pkgs.alpinelinux.org/package/edge/main/x86_64/curl" | grep -A3 Version | grep href | sed 's/<[^>]*>//g' | tr -d " ")
  - export build_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  - export vcs_ref=$(git rev-parse --short HEAD)

  # Montana's crucial workaround
  
script:
  - chmod u+x ./travis.sh
  - export DOCKER_CLI_EXPERIMENTAL=enabled
  - chmod u+x ./build.sh

after_success:
  - docker images
  - docker manifest inspect --verbose lucashalbert/curl
  - docker manifest inspect --insecure lucashalbert/curl
  - docker manifest inspect --verbose ppc64le/node
  - docker manifest inspect --insecure ppc64le/node
  - docker manifest inspect --verbose s390x/python
  - docker manifest inspect --insecure s390x/python
  - docker manifest inspect --verbose ibmjava:jre
  - docker manifest inspect --insecure ibmjava:jre

branches:
  only:
    - master
  except:
    - /^*-v[0-9]/
    - /^v\d.*$/
    
  # .travis.yml created by Montana Mendy for Travis CI & IBM - 12/15/-12/18/2020. 
